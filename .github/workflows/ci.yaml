name: Flutter CI/CD

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

env:
  FLUTTER_VERSION: "3.19.0"
  JAVA_VERSION: "17"
  GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

jobs:
  analyze_and_test:
    name: ðŸ” Analyze & Test
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”§ Create .env file
        run: echo "GOOGLE_MAPS_API_KEY=${{ env.GOOGLE_MAPS_API_KEY }}" > .env

      - name: ðŸ” Static analysis
        run: flutter analyze --fatal-infos

      - name: ðŸ§ª Run tests
        run: flutter test --coverage --reporter=expanded

      - name: ðŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: ðŸ“„ Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  dependency_check:
    name: ðŸ“‹ Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ” Check for outdated packages
        run: dart pub outdated --mode=null-safety

      - name: ðŸ”’ Check for security vulnerabilities
        run: |
          flutter pub deps
          echo "âœ… Dependency check completed"

  build_android:
    name: ðŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [analyze_and_test]
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”§ Create .env file
        run: echo "GOOGLE_MAPS_API_KEY=${{ env.GOOGLE_MAPS_API_KEY }}" > .env

      - name: ðŸ”¨ Build APK
        run: flutter build apk --release --split-per-abi

      - name: ðŸ“¦ Build App Bundle
        run: flutter build appbundle --release

      - name: ðŸ“± Upload APK (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-arm64
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          retention-days: 30

      - name: ðŸ“± Upload APK (armeabi-v7a)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-arm32
          path: build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          retention-days: 30

      - name: ðŸ“± Upload APK (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-x64
          path: build/app/outputs/flutter-apk/app-x86_64-release.apk
          retention-days: 30

      - name: ðŸ“¦ Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  # If builder in IOS
  # build_ios:
  #   name: ðŸŽ Build iOS
  #   runs-on: macos-latest
  #   needs: [analyze_and_test]
  #   if: runner.os == 'macOS' || github.event_name == 'workflow_dispatch'
  #   steps:
  #     - name: ðŸ“š Checkout repository
  #       uses: actions/checkout@v4

  #     - name: ðŸ¦ Set up Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         channel: stable
  #         flutter-version: ${{ env.FLUTTER_VERSION }}

  #     - name: ðŸ“¦ Get dependencies
  #       run: flutter pub get

  #     - name: ðŸ”§ Create .env file
  #       run: echo "GOOGLE_MAPS_API_KEY=${{ env.GOOGLE_MAPS_API_KEY }}" > .env

  #     - name: ðŸ”¨ Build iOS (no codesign)
  #       run: flutter build ios --release --no-codesign

  #     - name: ðŸ“± Archive iOS app
  #       run: |
  #         cd build/ios/iphoneos
  #         zip -r DoaLink-iOS.zip Runner.app

  #     - name: ðŸ“± Upload iOS Build
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: ios-build
  #         path: build/ios/iphoneos/DoaLink-iOS.zip
  #         retention-days: 30

  create_release:
    name: ðŸš€ Create Release Package
    runs-on: ubuntu-latest
    needs: [analyze_and_test, build_android, dependency_check]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Android APK (arm64)
        uses: actions/download-artifact@v4
        with:
          name: android-apk-arm64
          path: ./release/android/

      - name: ðŸ“¥ Download Android APK (arm32)
        uses: actions/download-artifact@v4
        with:
          name: android-apk-arm32
          path: ./release/android/

      - name: ðŸ“¥ Download Android APK (x64)
        uses: actions/download-artifact@v4
        with:
          name: android-apk-x64
          path: ./release/android/

      - name: ðŸ“¥ Download App Bundle
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: ./release/android/

      - name: ðŸ“‹ Generate build info
        run: |
          mkdir -p ./release/info
          cat > ./release/info/build_info.md << EOF
          # ðŸ“± DoaLink - Build Information

          ## ðŸ”§ Build Details
          - **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **Branch:** ${{ github.ref_name }}
          - **Commit:** ${{ github.sha }}
          - **Flutter Version:** ${{ env.FLUTTER_VERSION }}
          - **Java Version:** ${{ env.JAVA_VERSION }}
          - **Workflow:** ${{ github.workflow }}

          ## ðŸ“¦ Artifacts Included

          ### ðŸ¤– Android
          - **APK (ARM64):** \`app-arm64-v8a-release.apk\` - Para dispositivos modernos (recomendado)
          - **APK (ARM32):** \`app-armeabi-v7a-release.apk\` - Para dispositivos mais antigos
          - **APK (x64):** \`app-x86_64-release.apk\` - Para emuladores
          - **App Bundle:** \`app-release.aab\` - Para publicaÃ§Ã£o na Play Store

          ## ðŸ“² InstalaÃ§Ã£o

          1. **Baixe o APK ARM64** (recomendado para a maioria dos dispositivos)
          2. **Habilite "Fontes desconhecidas"** nas configuraÃ§Ãµes do Android
          3. **Instale o APK** no dispositivo

          ## âš ï¸ Notas Importantes

          - Este Ã© um build de produÃ§Ã£o com chave da API do Google Maps incluÃ­da
          - O APK estÃ¡ pronto para instalaÃ§Ã£o e uso imediato
          - Veja o arquivo \`INSTALL.md\` para instruÃ§Ãµes detalhadas de instalaÃ§Ã£o

          EOF

      - name: ðŸ“ Create installation instructions
        run: |
          cat > ./release/info/INSTALL.md << EOF
          # ðŸ“² InstruÃ§Ãµes de InstalaÃ§Ã£o - DoaLink

          ## ðŸ¤– Android

          ### OpÃ§Ã£o 1: APK (InstalaÃ§Ã£o Direta)
          1. **Escolha o APK correto:**
             - **ARM64** (\`app-arm64-v8a-release.apk\`): Para a maioria dos dispositivos modernos
             - **ARM32** (\`app-armeabi-v7a-release.apk\`): Para dispositivos mais antigos
             - **x64** (\`app-x86_64-release.apk\`): Para emuladores

          2. **Configure seu dispositivo:**
             - VÃ¡ em **ConfiguraÃ§Ãµes > SeguranÃ§a**
             - Habilite **"Fontes desconhecidas"** ou **"Instalar apps desconhecidos"**

          3. **Instale o app:**
             - Transfira o APK para seu dispositivo
             - Abra o arquivo APK
             - Toque em **"Instalar"**

          ### OpÃ§Ã£o 2: App Bundle (Para Desenvolvedores)
          - Use o arquivo \`.aab\` para publicar na Google Play Store
          - Requer conta de desenvolvedor do Google Play

          ## ðŸ”§ ConfiguraÃ§Ã£o Inicial

          1. **Google Maps:**
             - âœ… A chave da API do Google Maps jÃ¡ estÃ¡ incluÃ­da no APK
             - O mapa funcionarÃ¡ imediatamente apÃ³s a instalaÃ§Ã£o

          2. **PermissÃµes:**
             - O app solicitarÃ¡ permissÃµes de localizaÃ§Ã£o
             - NecessÃ¡rio para funcionalidades de mapa e geolocalizaÃ§Ã£o

          ## ðŸ†˜ Problemas Comuns

          - **"App nÃ£o instalado"**: Verifique se habilitou fontes desconhecidas
          - **"Arquivo corrompido"**: Baixe o APK novamente
          - **"Mapa nÃ£o carrega"**: Verifique sua conexÃ£o com a internet
          - **"LocalizaÃ§Ã£o nÃ£o funciona"**: Permita acesso Ã  localizaÃ§Ã£o nas configuraÃ§Ãµes

          EOF

      - name: ðŸ“¦ Create release package
        run: |
          cd release
          zip -r "../DoaLink-Release-${{ github.sha }}.zip" . -x "*.git*"
          cd ..

          # Criar um APK principal (ARM64) para instalaÃ§Ã£o rÃ¡pida
          cp "./release/android/app-arm64-v8a-release.apk" "./DoaLink-Install.apk"

      - name: ðŸš€ Upload final release package
        uses: actions/upload-artifact@v4
        with:
          name: doalink-complete-release
          path: DoaLink-Release-${{ github.sha }}.zip
          retention-days: 90

      - name: ðŸ“± Upload installation APK
        uses: actions/upload-artifact@v4
        with:
          name: doalink-install-apk
          path: DoaLink-Install.apk
          retention-days: 90

  notify_results:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [analyze_and_test, build_android, dependency_check, create_release]
    if: always()
    steps:
      - name: ðŸ“Š Check job results
        run: |
          echo "## ðŸ“Š Build Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Analyze & Test | ${{ needs.analyze_and_test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– Build Android | ${{ needs.build_android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ Dependency Check | ${{ needs.dependency_check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Create Release | ${{ needs.create_release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.create_release.result }}" == "success" ]]; then
            echo "âœ… **Release criado com sucesso!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“± **Para instalar:** Baixe o artifact \`doalink-install-apk\`" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **Release completo:** \`doalink-complete-release\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Falha na criaÃ§Ã£o do release**" >> $GITHUB_STEP_SUMMARY
          fi
